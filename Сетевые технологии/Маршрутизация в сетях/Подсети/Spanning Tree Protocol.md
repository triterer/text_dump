Spanning Tree Protocol
========================

STP - протокол [канального уровня](..%2FOSI%2F%D0%BA%D0%B0%D0%BD%D0%B0%D0%BB%D1%8C%D0%BD%D1%8B%D0%B9%20%28L2%2C%20data%20link%20layer%29.md), предназначенный для устранения петель в произвольных сетях Ethernet и приведения их к дроевовидной структуре путем отключения отдельных соединений между портами мостов (коммутаторов).  

## Для того чтобы определить какие порты заблокировать, а какие будут в режиме пересылки, STP выполняет следующее:

### 1. Выбор корневого моста
Корневым становится коммутатор с наименьшим идентификатором моста (Bridge ID).

Только один коммутатор может быть корневым. Для того чтобы выбрать корневой коммутатор, все коммутаторы отправляют сообщения BPDU, указывая себя в качестве корневого коммутатора. Если коммутатор получает BPDU от коммутатора с меньшим Bridge ID, то он перестает анонсировать информацию о том, что он корневой и начинает передавать BPDU коммутатора с меньшим Bridge ID. В итоге только один коммутатор останется корневым и будет передавать BPDU.

Изначально Bridge ID состоял из двух полей:

- Приоритет — поле, которое позволяет административно влиять на выборы корневого коммутатора. Размер — 2 байта,
- MAC-адрес — используется как уникальный идентификатор, который, в случае совпадения значений приоритетов, позволяет выбрать корневой коммутатор. Так как MAC-адреса уникальны, то и Bridge ID уникален, так что какой-то коммутатор обязательно станет корневым.

### 2. Определение корневых портов
Порт коммутатора, который имеет кратчайший путь к корневому коммутатору называется корневым портом. У любого не корневого коммутатора может быть только один корневой порт.

### 3. Определение назначенных портов
После этого для каждого сегмента сети просчитывается кратчайший путь к корневому порту. Мост, через который проходит этот путь, становится назначенным для этой сети (Designated Bridge). Непосредственно подключенный к сети порт моста — назначенным портом.

### 4. Блокирование прочих портов
Далее на всех мостах блокируются все порты, не являющиеся корневыми и назначенными. В итоге получается древовидная структура (математический граф) с вершиной в виде корневого коммутатора.

## Алгоритм действия STP
1. После включения коммутаторов в сеть, по умолчанию каждый (!) коммутатор считает себя корневым (root).
2. Затем коммутатор начинает посылать по всем портам конфигурационные Hello BPDU пакеты раз в 2 секунды.
3. Исходя из данных Hello BPDU пакетов, тот или иной коммутатор приобретает статус root, то есть корня.
4. После этого все порты кроме root port и designated port блокируются.

Происходит посылка Hello-пакетов раз в 20 секунд либо при пропадании/восстановлении какого-нибудь линка, с целью препятствия появлению петель в сети.

## Роли и состояния портов
Роли портов:
- Root Port — корневой порт коммутатора
- Designated Port — назначенный порт сегмента
- Nondesignated Port — неназначенный порт сегмента
- Disabled Port — порт который находится в выключенном состоянии

Состояния портов:
- Blocking — блокирование
- Listening — прослушивание
- Learning — обучение
- Forwarding — пересылка

