DLM
========================




Стурктура узла

```rust
enum NodeTypes {
    SCALAR,
    ARRAY,
    OBJECT
}

enum LockType {
    IntentShared,  
    IntentExclusive,
    Shared,
    Exclusive
}

struct Lock {
    lock_type: LockType,
    transaction_id: String
}

struct node {
    path: String,
    node_type: node_types,
    granted_locks: Vec(lock),
    locks_queue: Vec(lock),
    childrens: Vec(node)
}
```

Дерево блокировок формируется динамически для каждого документа. По мере продвижения мы проверяем совместимость имеющихся блокировок на узле с той блокировкой, которую хотим поставить. Если узла нет, то формируем его и ставим блокировку. 

Как мы блокируем узлы в одном файле?
Мы добавлям замок постепенно, проставляя интенционные блокировки на этапы пути и конкретные блокировки на узлы с которых начинаем собирать дерево для чтения или записи.

Как мы блокируем узлы в нескольких файлах?
Если есть список файлов для блокировки, то упорядочиваем все бокирвки в алфавитном порядке, а потом начинаем из исполнять.  
Если списка нет и у нас есть только условие для выбора нужных документов, то сначала мы производим блокировку чтения по атрибуту, по которому будет проходить фильтрация. Читаем данные этого атрибута в документах и собираем список документов. Потом проводим блокировку этих документов на нужном уровне и снимаем блокировки, которые ставили для чтения атрибутов для фильтрации. После этого рабоаем с выбранными документами.

Как мы перносим структуру из Schema Registry в DLM?
При получении запроса на блокировкуНАличие поля верифицируется с Schema Registry перед блокировками, так что если запрос блокировки дошёл до DLM, то сверять ничего уже не нужно.

Как мы действуем при расширении схемы?
Вроде ничего делать не надо. При добавлении узлов, мы просто их не читаем, так как не знали о существовании. А при добавлении новых типов данных мы сможем их прочесть.

Как синхронизируются замки в DLM?
Никак. Каждый инстанс управляет блокировками только на своём сервере.

Как блокируемся при транзитивных запросах, например join?
Блокировки чтения на каждый документ в обоих коллекциях. Потом чтение. Выборка подходящих под условие докуметов и повышение блокировк при необходимости.

Как хранить список документов в коллекции и как его обновлять?
Прям в KV хранилище по ключу d:collection:Docs = [Doc1, Doc2]. При обновлении надо ставить блокировки, благо для этого тоже можно построить дерево. В целом эта структура будет подвергнута постоянному насилию.