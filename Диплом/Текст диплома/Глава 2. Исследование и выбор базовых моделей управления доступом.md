Глава 2. Исследование и выбор базовых моделей управления доступом
========================


## 2.1. Определение эталонной модели и анализ ограничений блокировок на уровне документа

Для проведения объективного исследования и последующей оценки эффективности предлагаемых решений необходимо определить базовую модель (**baseline**), относительно которой будет производиться сравнение.
В документно-реляционных базах данных возникает специфическая проблема: данные обладают иерархической вложенностью, однако традиционные методы блокировок зачастую рассматривают документ как атомарную единицу. Формально представим документ *D* как ориентированное дерево *T=(V,E)*, где:
- V - множество узлов, представляющих атрибуты или вложенные объекты;
- E - множество связей, определяющих вложенность.

Традиционный подход (Baseline) ограничивает уровень гранулярности корнем дерева *Vroot*​. Это приводит к возникновению ложных конфликтов (false conflicts), когда две независимые транзакции *T1*​ и *T2*​ адресуют непересекающиеся подмножества узлов *Vi​⊂V* и *Vj​⊂V*, но блокируются на уровне *Vroot*​. Для примера рассмотрим документ представленный в листинге 2.1.1.
```
{
  "name": "Jason",
  "age": 39,
  "height": 1.92,
  "gender": "M",
  "married": true,
  "traits": ["lazy", "body modder"],
  "body parts": {
    "head": "normal",
    "left arm": "normal",
    "right arm": "missing",
    "left leg": "peg leg",
    "right leg": "archotech leg"
  },  "children": [
    {"name": "Tom", "age": 9},
    {"name": "Ava", "age": 7}
  ]
}
```

В рамках этой модели любая операция записи (*Write*) требует захвата эксклюзивной блокировки (*X*) на весь JSON-объект, а операция чтения (*Read*) — разделяемой блокировки (*S*). Математически это можно представить как неделимый ресурс. При поступлении запроса от транзакции *T1* на изменение поля *name* и запроса от транзакции *T2* на изменение поля *children* в рамках одного документа, возникает конфликт доступа, даже если поля *name* и *children* независимы. Поэтому основными недостатками данного подхода можно выделить:
1. **Низкая степень параллелизма:** Блокировка всего документа при работе с его вложенными структурами создает неоправданные очереди.
2. **Избыточное ожидание:** Транзакции простаивают, ожидая освобождения ресурса, который фактически ими не затрагивается.

Для преодоления данных ограничений в работе предлагается переход к модели иерархических блокировок (Multiple Granularity Locking, MGL). В отличие от плоской структуры, MGL позволяет выстраивать дерево ресурсов, где блокировка узла более низкого уровня (например, коллекции) позволяет получать доступ на чтение и изменение частей одного документа двумя транзакициями независимо друг от друга. Для примера можно представить приведённый выше документ в виде графа, представленного на рисунке 2.1.1.

![json_as_graph](../../media/json_graph.png)

При преобразовании хранимых документов к такому формату становится возможным применения гранулярных блокировок и транзакции *T1* и *T2* смогут получить доступ к требуемым для них ресурсам независимо. В данной работе иерархия строится динамически на основе структуры документа. Для обеспечения корректности взаимодействия различных уровней иерархии вводятся интенционные типы блокировок:
* **IS (Intent Shared)** — намерение прочитать данные на необходимых для выполнения запроса узлах;
* **S (Shared)** — активное чтение данных узла;
* **IX (Intent Exclusive)** — намерение модифицировать данные на запрашиваемых узлах;
* **X (Exclusive)** — активное изменение данных на запрашиваемых узлах.

Совместимость данных типов блокировок определяется классической матрицей совместимости, представленной в таблице 2.1.1, в которой "Да" обозначает что блокировки совместимы (транзакции могут работать параллельно), а "Нет" — конфликт (вторая транзакция должна ждать).

УЖЕ ЕСТЬ / ПРОСИТ|IS|IX|S|X
---|---|---|---|---
IS|Да|Да|Да|Нет
IX|Да|Да|Нет|Нет
S|Да|Нет|Да|Нет
X|Нет|Нет|Нет|Нет

Однако её применение в распределенной среде для динамически изменяющихся схем требует специализированного алгоритма.

## 2.2. Анализ эталонной модели (Baseline): Блокирование на уровне документа

Для оценки эффективности разрабатываемых методов в качестве эталона принята модель эксклюзивного блокирования объектов (Single-Level Locking). В распределенной среде данный метод реализуется через централизованный или распределенный менеджер блокировок (DLM), который оперирует уникальными идентификаторами документов (UUID).

В рамках исследования этой модели выделяются следующие критические показатели:
- Коэффициент блокировки (Block Ratio): Отношение времени ожидания ресурса к общему времени выполнения транзакции.
- Вероятность конфликта: Функция от количества параллельных сессий и среднего размера документа.

В данной главе проводится моделирование базового алгоритма с использованием сетей Петри. Модель «базового захвата» строится на основе позиций *P={Pfree​,Pwait​,Pexec​}* и переходов *T={Req,Acq,Rel}*. Анализ этой модели в условиях высокой конкуренции (High Contention) позволяет выявить верхний предел масштабируемости классического подхода, который и будет служить отправной точкой для оценки предлагаемых улучшений.

## Теоретические основы иерархического гранулирования ресурсов
Переход от атомарного блокирования документа к иерархическому требует введения многоуровневого протокола блокировок (Multiple Granularity Locking — MGL). В отличие от классических реляционных СУБД, где иерархия статична (База -> Таблица -> Страница -> Строка), в документно-реляционной БД иерархия должна строиться адаптивно.

Для реализации этого подхода необходимо исследовать:
- Механизм интенционных состояний: Как захват части документа влияет на возможность блокировки документа целиком другими узлами кластера.
- Динамическую схему как граф ресурсов: Как изменения в структуре файлов в реальном времени должны отражаться в Schema Registry без остановки обслуживания запросов.