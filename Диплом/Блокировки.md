Блокировки
========================

## Заблокированное состояние при использовании блокировок
### В пределах сервера
#### Ошибка на клиенте во время редактирования записи
1. Клиент читает файл с сервера с целью изменения и блокирует его для изменений
2. Клиент полчает ошибку при во время записи, без возможности восстановления

Файл остаётся в заблокированном состоянии без возможности восстановления.

Схема работы:

![petri_db_write_failure](../media/petri_db-%D0%97%D0%B0%D0%BF%D0%B8%D1%81%D1%8C%20%D1%84%D0%B0%D0%B9%D0%BB%D0%B0.png)

Порядок исполнения:
```
Клиент -> Получение метаданных таблицы -> Получение метаданных файла -> μ Ожидание • Проверить статус блокировки ->
    ( Ожидание
    | Заблокировать файл -> Записать файл -> Разблокировать Файл -> Клиент )
```
Порядок исполнения с возникновением ошибки:
```
Клиент -> Получение метаданных таблицы -> Получение метаданных файла -> μ Ожидание • Проверить статус блокировки ->
    ( Ожидание
    | Заблокировать файл -> СТОП
    | Заблокировать файл -> Записать файл -> Разблокировать Файл -> Клиент )
```

Псевдо sql:
```sql
UPDATE `Таблица` SET c1=c1+1 WHERE id=1;
```

#### Изменения двух клиентов
Первый клиент должен добавить имя работника к описанию его должности. Второй должен добавить каждому работнику название отдела в личные данные.

1. Первый клиент читает персональные работника и блокирует их.
2. Второй клиент читает должность работника и блокирует ее.
3. Первый клиент пытвается прочитать должность работника, но не может, так как она заблокированнна.
4. Второй клиент пытается прочитать персональные данные, но не может, так как они заблокированнна.

Оба клиента захватили часть данных и ожидают изменения друг у друга. Они заблокированны.

Состояние БД до изменений:

![petri_db_two_writes_schema](../media/petri_db-%D0%94%D0%B2%D0%B5%20%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8%20%D1%81%D1%85%D0%B5%D0%BC%D0%B0.png)

Схема работы:

![petri_db_two_writes_block](../media/petri_db-%D0%94%D0%B2%D0%B5%20%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8.png)

Порядок исполнения:
```
1.Клиент -> Получение метаданных таблицы Worker -> Получение метаданных файла worker/1111 -> μ Ожидание • Проверить статус блокировки файла worker/1111 ->
    ( Ожидание
    | Заблокировать файл worker/1111 -> Изменить файл worker/1111 -> Получить метаданные таблицы job -> Получить метаданные файла job/2111 -> μ Ожидание • Проверить статус блокировки файла job/2111 ->
        ( Ожидание
        | Заблокировать файл job/2111 -> Изменить файл job/2111 -> Разблокировать файл worker/1111 -> Разблокировать файл job/2111 -> 1.Клиент )
```
Псевдо sql:
```sql
UPDATE `Worker`
SET fk_job = 2112
WHERE id = 1111;
```
```
2.Клиент -> Получение метаданных таблицы Job -> Получение метаданных файла job/2111 -> μ Ожидание • Проверить статус блокировки файла job/2111 ->
    ( Ожидание
    | Заблокировать файл job/2111 -> Изменить файл job/2111 -> Получить метаданные таблицы worker -> Получить метаданные файла worker/1111 -> μ Ожидание • Проверить статус блокировки файла worker/1111 ->
        ( Ожидание
        | Заблокировать файл worker/1111 -> Изменить файл worker/1111 -> Разблокировать файл job/2111 -> Разблокировать файл worker/1111 -> 2.Клиент )
```
Псевдо sql:
```sql
UPDATE `JOB`
SET fk_worker = 1112
WHERE id = 2111;
```

#### Изменения ссылок
Первый клиент пытается перевести сотрудника в новый отдел. Второй пытается удалить отдел с удалением всех сотрудников в нём состоявших, для поддержания целостности

1. Первый клиент читает файл должности и блокирует его.
2. Второй клиент удаляет строку с отделом.
3. Второй клиент пытается изменить строку должности сотрудника, но не может. Так как она заблокированна.
4. Первый клиент пытается прочитать таблицу отделов с целью проверки корректности получаемой ссылки, но не может, так как она заблокированна.

В результате оба клиента заблокированны.

Схема БД до изменений:

![petri_db_change_links_schema](../media/petri_db-%D0%A1%D0%BC%D0%B5%D0%BD%D0%B0%20%D1%81%D1%81%D1%8B%D0%BB%D0%BE%D0%BA%20%D1%81%D1%85%D0%B5%D0%BC%D0%B0.png)

Схема работы:

![petri_db_link_change](../media/petri_db-%D0%A1%D0%BC%D0%B5%D0%BD%D0%B0%20%D1%81%D1%81%D1%8B%D0%BB%D0%BE%D0%BA-1.png)


```
1.Клиент -> Получение метаданных таблицы worker -> Получение ссылки на таблицу job -> μ Ожидание • Проверить блокировку строки job/2111 ->
    ( Ожидание
    | Заблокировать строку job/2111 -> Получить метаданные файлов department -> μ Ожидание • Проверить блокировку файла(department/X) ->
        (Ожидание
        | Прочитать файл(department/X) -> Ожидание) -> Изменить строку job/2111 -> Разблокировать строку job/2111 -> 1.Клиент
```
Псевдо sql:
```sql
UPDATE `Job`
SET fk_department = (select id from department where id = 4112)
WHERE fk_worker = (select id from worker where id = 1111);
```

```
2.Клиент -> Получение метаданных таблицы department -> μ Ожидание • Проверить блокировку строки department/4111 ->
    ( Ожидание
    | Заблокировать строку department/4111 -> Удалить файл department/4111 -> Получить метаданные таблицы job -> μ Ожидание • Проверить блокировку строки (job/X) ->
        ( Ожидание
        | Заблокировать строку (job/X) -> Изменить строку (Job/X)) -> μ Разблокировать строку (job/X) -> разблокировать строку department/4111 -> 2.Клиент
```
Псевдо sql:
```sql
DELETE FROM department WHERE id = 4111;
```

#### Взаимоисключающие операции в двух разных таблицах
Первый клиент пытается перенести компьютер из отдела 1 в отдел 2. А второй наоборот из отдела 2 в отдел 1.

В результате первый клиент не может корректно закончить работу. Зааписи остались в заблокированном состоянии.

Состояние БД до изменений:

![petri_db_concurent_operations_schema](../media/petri_db-%D0%9A%D0%BE%D0%BD%D0%BA%D1%83%D1%80%D0%B8%D1%80%D1%83%D1%8E%D1%89%D0%B8%D0%B5%20%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8%20%D0%A1%D1%85%D0%B5%D0%BC%D0%B0-3.png)



Схема работы:

![petri_db_concurent_operations](../media/petri_db-%D0%9A%D0%BE%D0%BD%D0%BA%D1%83%D1%80%D0%B8%D1%80%D1%83%D1%8E%D1%89%D0%B8%D0%B5%20%D0%BE%D0%BF%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8.png)


```
1.Клиент -> Получение метаданных таблицы department -> μ Ожидание • Проверить блокировку строки department/4111 ->
    ( Ожидание
    | Прочитать строку department/4111 -> Получить метаданные таблицы computer -> μ Ожидание • Проверить блокировку строки computer/5111 ->
        ( Ожидание
        | Заблокировать строку computer/5111 -> Прочитать файл computer/5111 ->  μ Ожидание • Проверить блокировку строки department/4112 ->
            ( Ожидание
            | Прочитатать строку department/4112 -> μ Ожидание • Проверить блокировку строки computer/5112 ->
                ( Ожидание
                | Заблокировать строку computer/5112 -> Прочитать файл computer/5112 -> Изменить файл computer/5111 -> изменить файл computer/5112 -> Разблокировать файл computer/5111 -> Разблокировать файл computer/5112)))) ->  1.Клиент
```
Псевдо sql:
```sql
UPDATE `Computer`
SET quantity = quantity + 1
WHERE fk_department = (select id from department where name = "Отдел 1");

UPDATE `Computer`
SET quantity = quantity - 1
WHERE fk_department = (select id from department where name = "Отдел 2");
```

```
2.Клиент -> Получение метаданных таблицы department -> μ Ожидание • Проверить блокировку строки department/4112 ->
    ( Ожидание
    | Прочитать строку department/4112 -> Получить метаданные таблицы computer -> μ Ожидание • Проверить блокировку строки computer/5112 ->
        ( Ожидание
        | Заблокировать строку computer/5112 -> Прочитать файл computer/5112 ->  μ Ожидание • Проверить блокировку строки department/4111 ->
            ( Ожидание
            | Прочитатать строку department/4111 -> μ Ожидание • Проверить блокировку строки computer/5111 ->
                ( Ожидание
                | Заблокировать строку computer/5111 -> Прочитать файл computer/5111 -> Изменить файл computer/5112 -> изменить файл computer/5111 -> Разблокировать файл computer/5112 -> Разблокировать файл computer/5111)))) ->  1.Клиент
```

Псевдо sql:
```sql
UPDATE `Computer`
SET quantity = quantity + 1
WHERE fk_department = (select id from department where name = "Отдел 2");

UPDATE `Computer`
SET quantity = quantity - 1
WHERE fk_department = (select id from department where name = "Отдел 1");
```

### В пределах кластера
#### Запись во время перебалансировки
Второй клиент должен вывести из эксплуатаии сервер, распределив записи с него на другие.

1. Первый клиент читает файл для изменения и блокирует его.
2. Второй клиент пытается заблокировать таблицу, но не может из-за блокировки первого.
3. Третий клиент читает другую строку и блокирует ёе для изменения.
4. Первый клиент завершает запись и разблокирует строку.
5. Второй клиент пытается заблокировать таблицу, но не может из-за блокировки третьего.

Данная ситуация с новыми блокировками может продолжатся бесконечно долго и второй так и не получит возможность заблокировать таблицу.
### Между кластерами
#### Синхронизация изменений
Блокировка изменений кластера происходит только в пределах одного кластера.
1. Первый клиент читает запись на первом кластере и блокирует её.
2. Второй клиент читает реплицированную запись на втором кластере и блокирует её.
3. Первый клиент завершает запись и снимает блокировку.
4. Второй клиент завершает запись и снимает блокировку.
5. Первый кластер блокирует строку, для подготовки к репликации.
6. Второй кластер блокирует строку для подготовки к репликации.
7. Первый кластер не может обновить строку на втором, так как она заблокированна.
8. Второй кластер не может обновить строку на первом, так как она заблокированна.

Оба кластера заблокировали у себя строку с целью репликации. Но не могут завершить операцию.
## Неконсистентное состояние при отсутсвии блокировок
### В пределах сервера
#### Ошибка на клиенте во время редактирования записи
1. Клиент читает файл с сервера с целью изменения
2. Клиент  удаляет старый файл
3. Клиент полчает ошибку при во время записи, без возможности восстановления

В результате данные в таблице повреждены.
#### Два клиента редактируют одну запись
1. Первый клиент читает файл с сервера с целью увеличить числовое значение на 1.
2. Второй клиент читает тот же файл с сервера с целью увеличить числовое значение на 1.
3. Первый клиент увеличивает значение на 1 локально и записывает получившийся файл
4. Второй клиент увеличивает значение на 1 локально и записывает получившийся файл

В результате файл увеличен на 1 только один раз.

#### Взаимоисключающие операции в двух разных таблицах
Первый клиент пытается перенести компьютер из отдела 1 в отдел 2. А второй выдать компьютер соруднику из отдлела 1. В отделе 1 толдько 1 компьютер
1. Первый клиент читает запись отдела 1.
2. Второй клиент читает запись отдела 1.
3. Первый клиент вычитает 1 из счётчика компьтеров в отделе 1.
4. Первый клиент записывает изменения.
5. Второй клиент вычитает 1 из счётчика компьютеров в отделе 1.
6. Второй клиент записывает изменения.
7. Первый клиент читает запись отдела 2.
8. Первый клиент увеличивает на 1 значение счётчика в отделе 2
9. Первый клиент записывает запись отдела 2.

По итогу один компьютер был одновременно выдан сотруднику и перенесён в отдел 2.