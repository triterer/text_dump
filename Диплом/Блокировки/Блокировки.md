Блокировки
========================
## Как работает блокировка
### Базовые функции
#### Блокировка узла S
```
LOCK_S(collection, doc, field, depth) -> μ Ожидание • Проверить наличие блокировок collection:doc:field ->
    ( Блокировка X -> ( Ожидание )
    | Блокировка IX ->
    | Блокировка S ->
    | Блокировка IS ->
    | Нет Блокировки -> добавить блокировку collection:doc:field:IS -> depth ->
        ( >1
        | Не объявлен -> Текущий узел коллекция ->
            ( Нет
            | Да -> Составить список дочерниих узлов -> μ • LOCK_S(collection, doc, μfield, depth-1)) ->
        | =1 -> μ Ожидание • Проверить наличие блокировок collection:doc:field ->
            ( Блокировка X ->
            | Блокировка IX -> ( Ожидание )
            | Блокировка S ->
            | Блокировка IS ->
            | Нет Блокировки -> Добавить блокировку collection:doc:field:S) -> Снять блокировку collection:doc:field:IS)
```
#### Разблокировка узла S
```
UNLOCK_S(collection, doc, field, depth) -> depth ->
    ( >1 ->
    | Не объявлен -> Текущий узел коллекция ->
        ( Нет
        | Да -> Составить список дочерниих узлов -> μ • UNLOCK_S(collection, doc, μfield, depth-1)) -> Удалить блокировку collection:doc:field:S)
    | =1)
```
#### Блокировка узла X
```
LOCK_X(collection, doc, field, depth) -> μ Ожидание • Проверить наличие блокировок collection:doc:field ->
    ( Блокировка X ->
    | Блокировка S ->
    | Блокировка IX -> ( Ожидание )
    | Блокировка IS ->
    | Нет Блокировки -> добавить блокировку collection:doc:field:IX -> depth ->
        ( >1 ->
        | Не объявлен -> Текущий узел коллекция ->
            ( Нет
            | Да -> Составить список дочерниих узлов -> μ • LOCK_X(collection, doc, μfield, depth-1)) ->
        | =1 -> μ Ожидание • Проверить наличие блокировок collection:doc:field ->
            ( Блокировка X -> ( Ожидание )
            | Блокировка IX ->
            | Блокировка S ->
            | Блокировка IS ->
            | Нет Блокировки -> Добавить блокировку collection:doc:field:X) -> Снять блокировку collection:doc:field:IX)
```
#### Разблокировка узла X
```
UNLOCK_X(collection, doc, field, depth) -> depth ->
    ( >1 ->
    | Не объявлен -> Текущий узел коллекция ->
        ( Нет ->
        | Да -> Составить список дочерниих узлов -> μ • UNLOCK_X(collection, doc, μfield, depth-1)) -> Удалить блокировку collection:doc:field:X))
```
### Чтение
При выполнении запроса требующем чтения одного или нескольких полей в древовидной структуре:
```
Запрос на чтение узла -> чтение из Schema Registry схемы указанной коллекции -> Проверка нужного поля в схеме ->
    ( Поля нет в схеме -> Возврат ошибки
    | Поле существует -> LOCK_S(collection, doc, field) -> Прочитать значение узла -> depth ->
        ( >1 ->
        | не объявлен -> Текущий узел коллекция -> Получить список дочерних полей -> μ • Прочитать значение дочернего поля -> Вернуть полученый файл -> UNLOCK_S(collection, doc, field)
        | =1)
```
### Поиск документа по фильтру
```
Запрос на поиск документов по условию -> Чтение из Schema Registry схемы указанной коллекции -> Проверка нужного поля ->
    ( Поля нет в схеме -> Возврат ошибки
    | Поле существует -> Получить список документов в этой коллекции -> μ • (LOCK_S(collection, μdoc, field, 1) -> Получить значение поля ->
        ( Не подходит для фильра -> UNLOCK_S(collection, μdoc, field, 1)
        | Подходит под условие фильтра -> Требуется прочитать весь документ ->
            ( Да -> LOCK_S(collection, μdoc, root) -> Прочитать документ -> UNLOCK_S(collection, μdoc, root)
            | Нет -> LOCK_S(collection, μdoc, field) -> Прочитать часть документа -> UNLOCK_S(collection, μdoc, field))))) -> Вернуть отфильтрованные документы
```

### Соединение двух json
```
Запрос на соединение двух коллекций -> получение структур обоих коллекций из Schema Registry ->
    ( Хоть одна из структур не содержит нужного поля -> Выход с ошибкой
    | LOCK_S(collection1,
```

### Запись
При выполнении запроса требующем записи одного или нескольких полей в древовидной структуре:
```
Запрос на запись значения -> чтение из Schema Registry схемы указанной коллекции -> Проверка нужного поля в схеме ->
    ( Поля нет в схеме -> Возврат ошибки
    | Поле существует -> Проверить наличие блокировок этого поля ->
        ( Блокировка X ->
        | Блокировка IX -> μ Ожидание • Проверить статус блокировки ->
            ( Ожидание ) ->
        | Блокировка S ->
        | Блокировка IS -> Добавить блокировку IX -> μ Ожидание • Проверить статус блокировки кроме одной IX ->
            ( Ожидание
            | Добавить блокировку X -> Удалить блокировку IX -> Запись древовидной структуры ->
                ( Нет
                | Да -> μ • Заблокировать каждый дочерний узел ) -> Записать текущий узел -> Запись древовидной структуры ->
                ( Нет
                | Да -> μ • Записать каждый дочерний узел -> Удалить блокировки X с дочерних узлов) -> Записать узел -> Удалить блокировку X с узла)) -> Завершить процесс
```



