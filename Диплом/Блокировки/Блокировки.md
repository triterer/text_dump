Блокировки
========================
## Как работает блокировка

### Чтение
При выполнении запроса требующем чтения одного или нескольких полей в древовидной структуре:
```
Запрос на чтение узла -> чтение из Schema Registry схемы указанной коллекции -> Проверка нужного поля в схеме ->
    ( Поля нет в схеме -> Возврат ошибки
    | Поле существует -> Проверить наличие блокировок этого поля ->
        ( Блокировка X ->
        | Блокировка IX -> μ Ожидание • Проверить статус блокировки ->
            ( Ожидание ) ->
        | Блокировка S ->
        | Блокировка IS ->
        | Нет Блокировки -> добавить блокировку IS -> Чтение древовидное -> (
            ( Нет
            | Да -> Текущий узел коллекция ->
                ( Нет
                | Да -> Составить список дочерниих узлов -> μ • Выполнить алгоритм чтения для дочерних узлов)) -> Проверить не появилось ли на текущем узле блокировки IX или X ->
                    ( Появилось -> μ Ожидание • Проверить статус блокировки ->
                        ( Ожидание ) ->
                    | Не появилось -> Добавить блокировку S -> Прочитать узел -> Снять блокировку S) -> Снять блокировку IS)) -> Вернуть значение узла
```
### Поиск документа по фильтру
```
Запрос на поиск документов по условию -> Чтение из Schema Registry схемы указанной коллекции -> Проверка нужного поля ->
    ( Поля нет в схеме -> Возврат ошибки
    | Поле существует -> Получить список документов в этой коллекции ->  μ Ожидание • Проверить статус следующего документа ->
        ( Блокировка X ->
        | Блокировка IX ->
        | Блокировка S ->
        | Блокировка IS ->μ Ожидание • Проверить статус блокировки ->
            ( Ожидание ) ->
        | Нет Блокировки) -> Добавить блокировку IS -> μ • Запрос на чтених элементов -> Добавить блокировку S -> Удалить блокировку IS -> Записать адрес документа) -> μ • Прочитать содержимое документов  -> μ • удалить блокировки документов S) -> Вернуть адреса документов и их содержимое.
```

### Соединение двух json


### Запись
При выполнении запроса требующем записи одного или нескольких полей в древовидной структуре:
```
Запрос на запись значения -> чтение из Schema Registry схемы указанной коллекции -> Проверка нужного поля в схеме ->
    ( Поля нет в схеме -> Возврат ошибки
    | Поле существует -> Проверить наличие блокировок этого поля ->
        ( Блокировка X ->
        | Блокировка IX -> μ Ожидание • Проверить статус блокировки ->
            ( Ожидание ) ->
        | Блокировка S ->
        | Блокировка IS -> Добавить блокировку IX -> μ Ожидание • Проверить статус блокировки кроме одной IX ->
            ( Ожидание
            | Добавить блокировку X -> Удалить блокировку IX -> Запись древовидной структуры ->
                ( Нет
                | Да -> μ • Заблокировать каждый дочерний узел ) -> Записать текущий узел -> Запись древовидной структуры ->
                ( Нет
                | Да -> μ • Записать каждый дочерний узел -> Удалить блокировки X с дочерних узлов) -> Записать узел -> Удалить блокировку X с узла)) -> Завершить процесс
```



